# Compilation
# ==============================================================================
MCU                                             = atmega48
OPT                                             = 2 -Wa,-a,-ad -finline-functions -fpredictive-commoning -fgcse-after-reload -fvect-cost-model  -fipa-cp-clone -ftree-loop-distribute-patterns -ftree-slp-vectorize
INLINE                                          =
FIXED_REGISTERS                                 = -ffixed-r3 -ffixed-r4 -ffixed-r5 -ffixed-r6 -ffixed-r7 -ffixed-r8 -ffixed-r9 -ffixed-r10 -ffixed-r11 -ffixed-r12 -ffixed-r13 -ffixed-r14 -ffixed-r15 -ffixed-r26 -ffixed-r27 -ffixed-r28 -ffixed-r29 -ffixed-r30 -ffixed-r31

# System
# ==============================================================================
F_CPU                                           = 8000000UL

# I/O matrix scanner
# ==============================================================================
IO_MATRIX__SCANNER__THREAD__IP__REG                     = 30
io_matrix__scanner__thread__function                    = timer0__overflow__interrupt__VECTOR
io_matrix__scanner__thread__function_attrs              = __attribute__((signal)) ISR_NAKED
io_matrix__scanner__thread__function_naked              = 1
io_matrix__scanner__thread__yield_with_reti             = 1
IO_MATRIX__SCANNER__THREAD__TIMER__CONF__INITIALIZED    = (TIMER0_CONF_DEFAULT)
IO_MATRIX__SCANNER__THREAD__TIMER__CONF__STARTED        = (TIMER0_CONF_PRESCALER_8)

# I/O Matrix
# ==============================================================================
IO_MATRIX__IN__PORT                             = B
IO_MATRIX__IN__BUTTONS_ENCODERS_A__PORT         = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ENCODERS_A__PIN          = 0
IO_MATRIX__IN__BUTTONS_ENCODERS_B__PORT         = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ENCODERS_B__PIN          = 1
IO_MATRIX__IN__BUTTONS_ROW0__PORT               = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ROW0__PIN                = 2
IO_MATRIX__IN__BUTTONS_ROW1__PORT               = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ROW1__PIN                = 3
IO_MATRIX__IN__BUTTONS_ROW2__PORT               = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ROW2__PIN                = 4
IO_MATRIX__IN__BUTTONS_ROW3__PORT               = IO_MATRIX__IN__PORT
IO_MATRIX__IN__BUTTONS_ROW3__PIN                = 5

IO_MATRIX__OUT__ROWS__PORT                      = D
IO_MATRIX__OUT__LED1R_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED1R_ROW__PIN                  = 2
IO_MATRIX__OUT__LED1G_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED1G_ROW__PIN                  = 3
IO_MATRIX__OUT__LED1B_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED1B_ROW__PIN                  = 4
IO_MATRIX__OUT__LED2R_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED2R_ROW__PIN                  = 5
IO_MATRIX__OUT__LED2G_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED2G_ROW__PIN                  = 6
IO_MATRIX__OUT__LED2B_ROW__PORT                 = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__LED2B_ROW__PIN                  = 7
IO_MATRIX__OUT__BUTTONS_LEDS_ROW__PORT          = IO_MATRIX__OUT__ROWS__PORT
IO_MATRIX__OUT__BUTTONS_LEDS_ROW__PIN           = 0

IO_MATRIX__OUT__COLUMNS__PORT                   = C
IO_MATRIX__OUT__COLUMN0__PORT                   = IO_MATRIX__OUT__COLUMNS__PORT
IO_MATRIX__OUT__COLUMN0__PIN                    = 0
IO_MATRIX__OUT__COLUMN1__PORT                   = IO_MATRIX__OUT__COLUMNS__PORT
IO_MATRIX__OUT__COLUMN1__PIN                    = 1
IO_MATRIX__OUT__COLUMN2__PORT                   = IO_MATRIX__OUT__COLUMNS__PORT
IO_MATRIX__OUT__COLUMN2__PIN                    = 2
IO_MATRIX__OUT__COLUMN3__PORT                   = IO_MATRIX__OUT__COLUMNS__PORT
IO_MATRIX__OUT__COLUMN3__PIN                    = 3


IO_MATRIX__IN__COLUMN0__STATE__REG              = 4
IO_MATRIX__IN__COLUMN1__STATE__REG              = 5
IO_MATRIX__IN__COLUMN2__STATE__REG              = 6
IO_MATRIX__IN__COLUMN3__STATE__REG              = 7

# Keyboard handler
# ==============================================================================
timer2__overflow__run                           = keyboard__debounce_timer__expired
TIMER2_OVERFLOW_vect_naked                      = 1
KEYBOARD__PORT_A__USED                          = 1
KEYBOARD__PORT_B__USED                          = 1
KEYBOARD__PORT_C__USED                          = 1
KEYBOARD__PORT_D__USED                          = 1

KEYBOARD__PORT_A__PREVIOUS_STATE__REG           = 8
KEYBOARD__PORT_B__PREVIOUS_STATE__REG           = 9
KEYBOARD__PORT_C__PREVIOUS_STATE__REG           = 10
KEYBOARD__PORT_D__PREVIOUS_STATE__REG           = 11

KEYBOARD__COMMON_MASK__REG                      = 3

KEYBOARD__PORT_A__MASK__REG                     = 12
KEYBOARD__PORT_B__MASK__REG                     = 13
KEYBOARD__PORT_C__MASK__REG                     = 14
KEYBOARD__PORT_D__MASK__REG                     = 15

# Keyboard pins (on logical ports: column 0 = port A, .. column 3 = port D)
# Buttons 0, 4, 8, 12 are in fact encoder switches.
# ==============================================================================
IN__BUTTON0__PORT                               = A
IN__BUTTON0__PIN                                = 2
IN__BUTTON1__PORT                               = A
IN__BUTTON1__PIN                                = 3
IN__BUTTON2__PORT                               = A
IN__BUTTON2__PIN                                = 4
IN__BUTTON3__PORT                               = A
IN__BUTTON3__PIN                                = 5
IN__BUTTON4__PORT                               = B
IN__BUTTON4__PIN                                = 2
IN__BUTTON5__PORT                               = B
IN__BUTTON5__PIN                                = 3
IN__BUTTON6__PORT                               = B
IN__BUTTON6__PIN                                = 4
IN__BUTTON7__PORT                               = B
IN__BUTTON7__PIN                                = 5
IN__BUTTON8__PORT                               = C
IN__BUTTON8__PIN                                = 2
IN__BUTTON9__PORT                               = C
IN__BUTTON9__PIN                                = 3
IN__BUTTON10__PORT                              = C
IN__BUTTON10__PIN                               = 4
IN__BUTTON11__PORT                              = C
IN__BUTTON11__PIN                               = 5
IN__BUTTON12__PORT                              = D
IN__BUTTON12__PIN                               = 2
IN__BUTTON13__PORT                              = D
IN__BUTTON13__PIN                               = 3
IN__BUTTON14__PORT                              = D
IN__BUTTON14__PIN                               = 4
IN__BUTTON15__PORT                              = D
IN__BUTTON15__PIN                               = 5

# TX ring buffer
# ==============================================================================
TX_RING_BUFFER__ALIGNED                         = 1
TX_RING_BUFFER__SIZE                            = 128
TX_RING_BUFFER__HEAD__REG                       = 26
TX_RING_BUFFER__TAIL__REG                       = 28

# TX Buffer NotEmpty flag placed into PORTD register, pin PD1, to signal alarm
TX_RING_BUFFER__NOT_EMPTY__HOST                 = PORTD
TX_RING_BUFFER__NOT_EMPTY__BIT                  = 1
TX_RING_BUFFER__NOT_EMPTY__IN_BIT_IO_MEM        = 1
# TX Buffer NotFull flag placed into ACSR register (not used in the code)
TX_RING_BUFFER__NOT_FULL__HOST                  = GPIOR0
TX_RING_BUFFER__NOT_FULL__BIT                   = 0
TX_RING_BUFFER__NOT_FULL__IN_BIT_IO_MEM         = 1

# I/O
# ==============================================================================
OUT__ALARM__PORT                                = D
OUT__ALARM__PIN                                 = 1

# I2C
# ==============================================================================
TWI__SLAVE__ADDRESS                             = 0x20
